<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Algum Creations Billing 2026</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body{
  font-family:'Segoe UI',sans-serif;
  margin:0;
  padding:20px;
  background:linear-gradient(135deg,#1e1e2f,#2b1055);
  color:white;
}
.container{
  max-width:1500px;
  margin:auto;
  background:#111827;
  padding:40px;
  border-radius:35px;
  box-shadow:0 0 60px rgba(255,215,0,0.3);
}
.brand{text-align:center;margin-bottom:20px;}
.brand h1{
  margin:0;
  font-size:32px;
  background:linear-gradient(45deg,gold,#ffcc00);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.brand p{color:#ccc;}
input, select{
  padding:10px;
  border-radius:10px;
  border:none;
  font-size:14px;
  margin-bottom:10px;
  background:#1f2937;
  color:white;
}
button{
  padding:18px 24px;
  border:none;
  border-radius:18px;
  cursor:pointer;
  font-weight:bold;
  margin-top:16px;
  transition:0.3s;
}
.primary{background:linear-gradient(45deg,#ff9800,#ff5722);color:white;}
.secondary{background:linear-gradient(45deg,#25D366,#128C7E);}
.download{background:linear-gradient(45deg,#2196f3,#3f51b5);}
.thermal{background:linear-gradient(45deg,#ff00cc,#3333ff);}
.advanceBtn{background:linear-gradient(45deg,#00c6ff,#0072ff);}
button:hover{transform:scale(1.05);}
.itemRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center;}
.removeBtn{
  background:red;
  color:white;
  border:none;
  border-radius:50%;
  width:35px;
  height:35px;
  cursor:pointer;
  font-weight:bold;
  font-size:22px;
}
.invoice{
  background:white;
  color:black;
  padding:30px;
  border-radius:20px;
  position:relative;
  margin-top:25px;
}
.statusBadge{
  position:absolute;
  top:20px;
  right:20px;
  padding:8px 15px;
  border-radius:20px;
  font-weight:bold;
  color:white;
}
.paid{ background:green; }
.due{ background:red; }
.partial{ background:orange; }
.invoice table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
.invoice th{
  background:#111827;
  color:white;
}
.invoice th, .invoice td{
  padding:10px;
  border:1px solid #ddd;
  text-align:center;
}
.totalBox{
  margin-top:24px;
  text-align:right;
  font-weight:bold;
  font-size:22px;
}
#totalPreview{
  font-weight:bold;
  margin:16px 0;
  font-size:24px;
}
.clientPopup{
  background:#222;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}
.clientPopup p{
  margin:3px 0;
}
</style>
</head>

<body>

<div class="container">

<div class="brand">
<h1>ALGUM CREATIONS</h1>
<p>Creative Design • Branding • Digital Solutions</p>
<p>Developed By Rohit Gupta</p>
</div>

<input type="text" id="customer" placeholder="Client Name" style="width:100%;">
<input type="tel" id="mobile" value="+91" style="width:100%;">

<button class="primary" onclick="fetchClient()">Fetch Client</button>

<div id="clientDetails"></div>

<div id="items"></div>
<div id="totalPreview">Total: ₹0</div>
<button class="primary" onclick="addRow()">+ Add Service</button>

<br><br>
<input type="number" id="discount" placeholder="Discount Amount ₹" style="width:200px;">
<br><br>

<select id="paymentMode">
<option value="Online">Online</option>
<option value="Cash">Cash</option>
</select>

<input type="number" id="paidAmount" placeholder="Paid Amount ₹">
<br><br>

<button class="primary" onclick="createBill()">Generate Invoice</button>

<input type="number" id="advanceAmount" placeholder="Enter Amount ₹" style="width:200px; margin-left:15px;">
<button class="advanceBtn" onclick="generateAdvanceQR('advance')">Advance QR</button>
<button class="advanceBtn" onclick="generateAdvanceQR('full')">Full Payment QR</button>

<div id="advancePreview"></div>
<div id="billPreview" style="margin-top:30px;"></div>

<div id="afterButtons" style="display:none;">
<button class="download" onclick="downloadBill()">Download</button>
<button class="secondary" onclick="shareWhatsApp()">WhatsApp</button>
<button class="thermal" onclick="window.print()">Print</button>
</div>

</div>

<script>
const UPI_ID="tinu01jmp@okhdfcbank";
let advanceUpiLink="";
let billUpiLink="";
const SHEET_API="https://script.google.com/macros/s/AKfycbz7L7LsHuTui703d62Yt4PO4Wtw69a4ALM-eVJqJmalwYcygLgq6EPPS8kuwRQNh28dcQ/exec";

const services=[
{name:"Single Page Poster",price:349},
{name:"Signature Poster Design",price:499},
{name:"Duo Poster Pack (2 Designs)",price:649},
{name:"Trio Poster Pack (3 Designs)",price:949},
{name:"Ultimate Poster Pack (4 Designs)",price:1199},
{name:"Classic Single Page Invitation",price:499},
{name:"Luxury Single Page Invitation",price:649},
{name:"Grand 4-Page Wedding Invitation",price:999},
{name:"Additional Page (Add-On)",price:299},
{name:"Essential Logo Design",price:999},
{name:"Elite Logo Design",price:1299},
{name:"Single Page Menu Design",price:549},
{name:"Double Page Menu Design",price:849},
{name:"Banner / Flex Designing (Per Feet)",price:49},
{name:"Social Media Post Design",price:249}
];

// --- ADD SERVICE ROW WITH REMOVE BUTTON ---
function addRow(){
  let div=document.createElement("div");
  div.className="itemRow";

  let options="";
  services.forEach((service,index)=>{
    options+=`<option value="${index}">${service.name} - ₹${service.price}</option>`;
  });

  div.innerHTML=`
    <select class="serviceSelect">${options}</select>
    <input type="number" class="qty" value="1" min="1">
    <button class="removeBtn" onclick="removeRow(this)">×</button>
  `;
  document.getElementById("items").appendChild(div);
  updateTotal();
}

// --- REMOVE SERVICE ROW ---
function removeRow(btn){
  btn.parentElement.remove();
  updateTotal();
}

// --- UPDATE TOTAL ---
function updateTotal(){
  let total=0;
  document.querySelectorAll(".itemRow").forEach(row=>{
    let idx=row.querySelector(".serviceSelect").value;
    let qty=parseFloat(row.querySelector(".qty").value)||1;
    total+=services[idx].price*qty;
  });
  document.getElementById("totalPreview").innerText="Total: ₹"+total.toFixed(2);
}
document.addEventListener("input", e=>{
  if(e.target.classList.contains("qty") || e.target.classList.contains("serviceSelect")){
    updateTotal();
  }
});

addRow(); // initial row

// --- FETCH CLIENT DETAILS ---
async function fetchClient(){
  let phone=document.getElementById("mobile").value.replace(/\D/g,"");
  if(phone.length===10) phone="91"+phone;
  
  try{
    const res=await fetch(SHEET_API,{
      method:'POST',
      body:JSON.stringify({action:"getClient",phone})
    });
    const data=await res.json();

    let popup=document.getElementById("clientDetails");
    popup.innerHTML="";
    if(data.found){
      popup.innerHTML=`
      <div class="clientPopup">
        <p><strong>Name:</strong> ${data.name}</p>
        <p><strong>Total Bill:</strong> ₹${data.totalBill}</p>
        <p><strong>Total Paid:</strong> ₹${data.totalPaid}</p>
        <p><strong>Total Due:</strong> ₹${data.totalDue}</p>
        <p><strong>Last Updated:</strong> ${data.lastUpdated||"N/A"}</p>
      </div>`;
      document.getElementById("customer").value=data.name;
    }else{
      popup.innerHTML=`<p>Client not found, you can add new.</p>`;
    }
  }catch(err){
    console.error(err);
    alert("Error fetching client from Sheet.");
  }
}

// --- ADVANCE / FULL PAYMENT QR ---
function generateAdvanceQR(type){
  let customer=document.getElementById("customer").value || "N/A";
  let rows=document.querySelectorAll(".itemRow");
  let subtotal=0;
  rows.forEach(row=>{
    let serviceIndex=row.querySelector(".serviceSelect").value;
    let service=services[serviceIndex];
    let qty=parseFloat(row.querySelector(".qty").value)||1;
    subtotal+=service.price*qty;
  });
  let amount=0,title="";
  if(type==="full"){ amount=subtotal; title="FULL PAYMENT REQUEST"; }
  else{ amount=parseFloat(document.getElementById("advanceAmount").value)||0; if(amount<=0){ alert("Enter Advance"); return; } title="ADVANCE PAYMENT REQUEST"; }

  advanceUpiLink=`upi://pay?pa=${UPI_ID}&pn=Algum%20Creations&am=${amount.toFixed(2)}&cu=INR`;
  let date=new Date().toLocaleDateString();
  let receiptHTML=`
  <div class="invoice">
    <h3 style="text-align:center;">${title}</h3>
    <hr>
    <p><strong>Customer:</strong> ${customer}</p>
    <p><strong>Amount:</strong> ₹${amount.toFixed(2)}</p>
    <p><strong>Date:</strong> ${date}</p>
    <div id="advanceQR" style="margin-top:15px;"></div>
    <br>
    <button class="secondary" onclick="shareAdvanceWhatsApp('${amount.toFixed(2)}','${title}')">Share WhatsApp</button>
  </div>`;
  document.getElementById("advancePreview").innerHTML=receiptHTML;
  new QRCode(document.getElementById("advanceQR"), advanceUpiLink);
}

function shareAdvanceWhatsApp(amount,title){
  let mobile=document.getElementById("mobile").value.replace(/\D/g,"");
  if(mobile.length===10) mobile="91"+mobile;
  let message=`*ALGUM CREATIONS*\n${title}\nClient: ${document.getElementById("customer").value}\nAmount: ₹${amount}\nPayment Link: ${advanceUpiLink}`;
  window.open(`https://wa.me/${mobile}?text=${encodeURIComponent(message)}`,"_blank");
}

// --- CREATE BILL AND POST TO SHEET ---
async function createBill(){
  let customer=document.getElementById("customer").value || "N/A";
  let mobile=document.getElementById("mobile").value.replace(/\D/g,"")||"N/A";
  if(mobile.length===10) mobile="91"+mobile;

  let paymentMode=document.getElementById("paymentMode").value;
  let paid=parseFloat(document.getElementById("paidAmount").value)||0;
  let discount=parseFloat(document.getElementById("discount").value)||0;

  let rows=document.querySelectorAll(".itemRow");
  let subtotal=0;
  let tableHTML="<table><tr><th>Service</th><th>Qty</th><th>Price</th><th>Total</th></tr>";
  rows.forEach(row=>{
    let serviceIndex=row.querySelector(".serviceSelect").value;
    let service=services[serviceIndex];
    let qty=parseFloat(row.querySelector(".qty").value)||1;
    let amount=service.price*qty;
    subtotal+=amount;
    tableHTML+=`<tr><td>${service.name}</td><td>${qty}</td><td>₹${service.price}</td><td>₹${amount}</td></tr>`;
  });
  tableHTML+="</table>";

  let total=subtotal-discount;
  let balance=total-paid;
  let status=balance<=0?"PAID":paid>0?"PARTIAL":"DUE";

  let date=new Date().toLocaleDateString();
  let invoiceNo="AC-"+Date.now().toString().slice(-6);

  // --- BUILD BILL HTML ---
  let billHTML=`
  <div id="finalBill" class="invoice">
    <div class="statusBadge ${status==="PAID"?"paid":status==="PARTIAL"?"partial":"due"}">${status}</div>
    <h2 style="text-align:center;">ALGUM CREATIONS</h2>
    <p style="text-align:center;">One Stop Solution For Digital Business</p>
    <hr>
    <p><strong>Invoice No:</strong> ${invoiceNo}</p>
    <p><strong>Date:</strong> ${date}</p>
    <p><strong>Client:</strong> ${customer}</p>
    <p><strong>Mobile:</strong> ${mobile}</p>
    <p><strong>Payment Mode:</strong> ${paymentMode}</p>
    ${tableHTML}
    <div class="totalBox">
      Subtotal: ₹${subtotal.toFixed(2)}<br>
      Discount: ₹${discount.toFixed(2)}<br>
      Grand Total: ₹${total.toFixed(2)}<br>
      Paid: ₹${paid.toFixed(2)}<br>
      Balance: ₹${balance.toFixed(2)}
    </div>
    ${balance>0?`<div style="margin-top:20px;text-align:center;"><h3>Scan to Pay ₹${balance.toFixed(2)}</h3><div id="billQR"></div></div>`:""}
  </div>`;
  document.getElementById("billPreview").innerHTML=billHTML;
  document.getElementById("afterButtons").style.display="block";

  if(balance>0){
    billUpiLink=`upi://pay?pa=${UPI_ID}&pn=Algum%20Creations&am=${balance.toFixed(2)}&cu=INR`;
    new QRCode(document.getElementById("billQR"), billUpiLink);
  }

  window.billData={customer,mobile,total,status};

  // --- POST TO GOOGLE SHEET ---
  try{
    const res=await fetch(SHEET_API,{
      method:'POST',
      body:JSON.stringify({action:"addBill",phone:mobile,name:customer,amount:total})
    });
    const data=await res.json();
    if(data.success) console.log("Bill added ✅");
    else console.warn("Failed to add bill");
    if(paid>0){
      const payRes=await fetch(SHEET_API,{
        method:'POST',
        body:JSON.stringify({action:"addPayment",phone:mobile,amount:paid,mode:paymentMode})
      });
      const payData=await payRes.json();
      if(payData.success) console.log("Payment added ✅");
    }
  }catch(err){ console.error("Sheet update error:",err);}
}

function downloadBill(){
  html2canvas(document.getElementById("finalBill")).then(canvas=>{
    let link=document.createElement("a");
    link.download="Algum_Creations_Invoice.png";
    link.href=canvas.toDataURL();
    link.click();
  });
}

function shareWhatsApp(){
  let data=window.billData;
  if(!data){ alert("Generate Invoice First"); return; }
  let mobile=data.mobile.replace(/\D/g,"");
  if(mobile.length===10) mobile="91"+mobile;
  let message=`*ALGUM CREATIONS*\nInvoice Status: ${data.status}\nTotal: ₹${data.total}\n${data.status!=="PAID"?"Payment Link:\n"+billUpiLink+"\n":""}`;
  window.open(`https://wa.me/${mobile}?text=${encodeURIComponent(message)}`,"_blank");
}
</script>
</body>
</html>
